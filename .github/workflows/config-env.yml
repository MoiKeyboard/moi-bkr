# IBKR/config/README.md
name: Config Env

on:
  workflow_run:
    workflows: ["Config Sync"]  # Name must match config-sync.yml's name
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-config:
    # Only run if the config-sync workflow succeeded and it was a merge to main
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'pull_request' &&
       github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml yamllint yq dotenv
          # Install SOPS
          curl -L https://github.com/mozilla/sops/releases/download/v3.7.3/sops-v3.7.3.linux.amd64 -o sops
          chmod +x sops
          sudo mv sops /usr/local/bin/

      - name: Setup SOPS
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY_FILE }}
        run: |
          echo "Extracting public key from SOPS_AGE_KEY secret"
          PUBLIC_KEY=$(echo "$SOPS_AGE_KEY" | awk '/public key:/ {print $4}' | tr -d '\n\r')
          echo "Extracting public key from .sops.yaml"
          CONFIG_KEY=$(yq --yaml-output '.creation_rules[0].age' config/.sops.yaml | sed 's/\.\.\.$//' | tr -d '\n\r')
          
          # Debug output with string lengths and hex dump
          echo "Public key length: ${#PUBLIC_KEY}"
          echo "Config key length: ${#CONFIG_KEY}"
          echo "Public key:"
          echo "$PUBLIC_KEY" | xxd
          echo "Config key:"
          echo "$CONFIG_KEY" | xxd
          
          if [ "$PUBLIC_KEY" != "$CONFIG_KEY" ]; then
            echo "Error: SOPS age key doesn't match .sops.yaml configuration"
            echo "Expected: $CONFIG_KEY"
            echo "Got: $PUBLIC_KEY"
            exit 1
          fi

      - name: Generate and Encrypt Base Environment Variables
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY_FILE }}
        run: |
          # Generate base.env template in /tmp
          python .github/workflows/scripts/generate_env.py \
            --config-dir config \
            --input-yaml base.yml \
            --output-dir /tmp
          
          # If base.env exists in repo, try to decrypt it
          if [ -f "config/base.env" ]; then
            echo "Attempting to decrypt existing base.env..."
            if sops --config config/.sops.yaml --decrypt config/base.env > /tmp/existing_base.env 2>/dev/null; then
              echo "Successfully decrypted existing base.env"
            else
              echo "Failed to decrypt existing base.env, creating new one..."
              cp /tmp/base.env /tmp/existing_base.env
            fi
            
            # Merge existing encrypted values with new template
            python .github/workflows/scripts/merge_secrets.py base
            mv /tmp/base.env /tmp/final_base.env
          else
            echo "No existing base.env, using generated template..."
            mv /tmp/base.env /tmp/final_base.env
          fi

          # Encrypt the final base.env
          echo "Encrypting final base.env..."
          sops --config config/.sops.yaml \
               --encrypt /tmp/final_base.env > config/base.env || {
            echo "Failed to encrypt base.env"
            cat config/.sops.yaml
            exit 1
          }
          
          echo "### Base Environment Variable Generation Results üìù" >> $GITHUB_STEP_SUMMARY
          echo "#### Warnings:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          { echo "$OUTPUT" | grep "Warning:" || true; } >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "#### Results:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          { echo "$OUTPUT" | grep "Generated\|Found\|Notice:" || true; } >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "Current directory: $(pwd)"
          echo "Contents of /tmp:"
          ls -la /tmp/final_base.env
          echo "Contents of config directory:"
          ls -la config/

      - name: Generate and Encrypt Environment-Specific Variables
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY_FILE }}
        run: |
          for ENV in development production; do
            echo "Processing $ENV environment..."
            
            # 1. Generate template from base.yml for structure
            TEMPLATE_OUTPUT=$(python .github/workflows/scripts/generate_env.py \
              --config-dir config \
              --environment $ENV \
              --input-yaml base.yml \
              --output-dir /tmp/templates)
            
            # 2. Decrypt base.env (our source of default values)
            sops --decrypt config/base.env > /tmp/base.env
            
            # 3. Handle existing environment file if it exists
            if [ -f "config/environments/$ENV.env" ]; then
              echo "Decrypting existing $ENV.env..."
              sops --decrypt "config/environments/$ENV.env" > "/tmp/$ENV.env"
            else
              echo "No existing $ENV.env, creating new from template..."
              cp "/tmp/templates/$ENV.env" "/tmp/$ENV.env"
            fi
            
            # 4. Merge secrets following CRUD rules
            echo "Merging secrets for $ENV..."
            MERGE_OUTPUT=$(python .github/workflows/scripts/merge_secrets.py $ENV)
            
            # 5. Format the merged file
            sort "/tmp/$ENV.env" > "/tmp/$ENV.env.sorted"
            mv "/tmp/$ENV.env.sorted" "/tmp/$ENV.env"
            
            # 6. Encrypt the final environment file
            echo "Encrypting final $ENV.env..."
            mkdir -p config/environments
            sops --config config/.sops.yaml encrypt "/tmp/$ENV.env" > "config/environments/$ENV.env"
            
            # 7. Clean up temporary files
            rm -f "/tmp/$ENV.env" "/tmp/templates/$ENV.env"
            
            # Add to GitHub Step Summary
            echo "### $ENV Environment Variable Results üîß" >> $GITHUB_STEP_SUMMARY
            echo "#### Template Generation:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$TEMPLATE_OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            echo "#### Merge Results:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$MERGE_OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          done
          
          # Clean up remaining temporary files
          rm -f /tmp/base.env /tmp/existing_base.env /tmp/final_base.env

      - name: Format ENV Files
        run: |
          # Function to format env file
          format_env_file() {
            local file=$1
            if [ -f "$file" ]; then
              # Sort and clean the file
              sort "$file" > "$file.tmp"
              tr -d '\r' < "$file.tmp" > "$file.clean"
              mv "$file.clean" "$file"
              rm "$file.tmp"
              echo "Formatted $file"
            fi
          }
          
          # Format base.env
          format_env_file "config/base.env"
          
          # Format environment-specific files
          for ENV in development production; do
            format_env_file "config/environments/$ENV.env"
          done

      - name: Check for configuration changes
        id: check-changes
        run: |
          if [[ $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add config/base.env config/environments/*.env
          git commit -m "chore: update and encrypt environment files"
          git push origin main

      - name: Report Status
        if: always()
        run: |
          echo "Config Env Summary:"
          echo "- Sync status: ${{ job.status }}"
          echo "- Base env file: $(test -f config/base.env && echo '‚úÖ' || echo '‚ùå')"
          for ENV in development production; do
            echo "- $ENV env file: $(test -f config/environments/$ENV.env && echo '‚úÖ' || echo '‚ùå')"
          done
