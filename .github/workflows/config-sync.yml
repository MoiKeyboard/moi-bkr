# IBKR/config/README.md
name: Config Sync

on:
  push:
    paths:
      - 'config/base.yml'
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Sync Configuration Files
        run: |
          python .github/workflows/scripts/config_sync.py

      - name: Check and Create PR if needed
        id: sync-check
        run: |
          if [[ $(git status --porcelain) ]]; then
            echo "Changes detected after config sync"
            
            # Create PR body file
            rm -f /tmp/pr-body.md
            echo "This PR synchronizes environment configurations with base.yml" > /tmp/pr-body.md
            echo >> /tmp/pr-body.md
            echo "### Changes Overview" >> /tmp/pr-body.md
            echo "This automated PR updates environment-specific configurations to align with changes in base.yml." >> /tmp/pr-body.md
            echo >> /tmp/pr-body.md
            echo "### Diff Details" >> /tmp/pr-body.md
            echo '```diff' >> /tmp/pr-body.md
            git diff >> /tmp/pr-body.md
            echo '```' >> /tmp/pr-body.md
            echo >> /tmp/pr-body.md
            echo "### Notes" >> /tmp/pr-body.md
            echo "- Only environment-specific overrides are preserved" >> /tmp/pr-body.md
            echo "- All other values are inherited from base.yml" >> /tmp/pr-body.md
            echo "- Review the changes to ensure no environment-specific configurations were accidentally modified" >> /tmp/pr-body.md
            
            # Configure git
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            
            # Create new branch with timestamp
            BRANCH_NAME="auto/config-sync-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"
            
            # Commit and push changes to new branch
            git add config/environments/*.yml
            git commit -m "chore: sync environment configs with base.yml"
            git push origin "$BRANCH_NAME"
            
            # Create Pull Request using GitHub CLI with error handling
            echo "Creating pull request..."
            gh pr create \
              --title "Config Sync: Update environment configurations" \
              --body-file /tmp/pr-body.md \
              --base main \
              --head "$BRANCH_NAME" || {
                echo "Failed to create PR, but changes are pushed to branch $BRANCH_NAME"
                exit 0
              }
          fi

      - name: Report Status
        if: always()
        run: |
          echo "Config Sync Summary:"
          echo "- Sync status: ${{ job.status }}"
